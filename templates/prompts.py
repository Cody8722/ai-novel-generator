# -*- coding: utf-8 -*-
"""
AI å°èªªç”Ÿæˆå™¨ - æç¤ºè©æ¨¡æ¿ç®¡ç†
"""


class PromptTemplates:
    """æç¤ºè©æ¨¡æ¿ç®¡ç†é¡åˆ¥"""

    # ç³»çµ±æ ¸å¿ƒè¦å‰‡ï¼ˆæ¯æ¬¡ç”Ÿæˆéƒ½è¦æ³¨å…¥ï¼‰
    SYSTEM_CORE = """ä½ æ˜¯å°ˆæ¥­å°èªªä½œå®¶ï¼Œæ“…é•·å‰µä½œå¼•äººå…¥å‹çš„æ•…äº‹ã€‚

æ ¸å¿ƒè¦å‰‡ï¼ˆæ°¸é éµå®ˆï¼‰:
1. åš´æ ¼æŒ‰ç…§å¤§ç¶±å‰µä½œï¼Œä¸åé›¢ä¸»ç·š
2. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´ï¼Œä¸çªç„¶æ”¹è®Š
3. å»¶çºŒå‰æ–‡åŠ‡æƒ…ï¼Œç¢ºä¿é€£è²«æ€§
4. å­—æ•¸æ§åˆ¶åœ¨ 2500-3500 å­—ä¹‹é–“
5. ä¸æ·»åŠ ç« ç¯€æ¨™é¡Œï¼Œç›´æ¥é–‹å§‹æ­£æ–‡
6. ä½¿ç”¨ç¬¬ä¸‰äººç¨±æ•˜è¿°
7. æ®µè½é–“ä½¿ç”¨ç©ºè¡Œåˆ†éš”

ç¦æ­¢äº‹é …:
- ä¸è¦è·³å‡ºæ•…äº‹åšæ—ç™½è©•è«–
- ä¸è¦ç·¨é€ å¤§ç¶±ä¸­æ²’æœ‰çš„è¨­å®š
- ä¸è¦è®“è§’è‰²çªç„¶æ€§æ ¼å¤§è®Š
- ä¸è¦é‡è¤‡å·²ç™¼ç”Ÿçš„äº‹ä»¶
"""

    # æ ¼å¼æ§åˆ¶
    FORMAT_RULES = """
è¼¸å‡ºæ ¼å¼è¦æ±‚:
1. åªè¼¸å‡ºæ­£æ–‡å…§å®¹
2. ä¸è¦ä½¿ç”¨ ``` ä»£ç¢¼å¡Šæ¨™è¨˜
3. æ®µè½é–“ç”¨ç©ºè¡Œåˆ†éš”
4. ç›´æ¥é–‹å§‹æ•…äº‹ï¼Œä¸è¦é–‹å ´ç™½
5. çµå°¾ä¸è¦ã€Œæœ¬ç« å®Œã€ç­‰æ¨™è¨˜
6. ä¸è¦æ·»åŠ ä»»ä½• JSON æ ¼å¼
"""

    # ä¸€è‡´æ€§è¦æ±‚
    CONSISTENCY_RULES = """
ä¸€è‡´æ€§æª¢æŸ¥:
1. ä»”ç´°é–±è®€ã€å‰æ–‡å›é¡§ã€‘ï¼Œç¢ºä¿æƒ…ç¯€é€£è²«
2. è§’è‰²è¨­å®šå¿…é ˆèˆ‡ä¹‹å‰ä¸€è‡´
3. æ™‚é–“ç·šè¦åˆç†ï¼Œä¸èƒ½éŒ¯äº‚
4. ä¸é‡è¤‡å·²ç™¼ç”Ÿçš„äº‹ä»¶
5. ä¸–ç•Œè§€è¨­å®šå‰å¾Œçµ±ä¸€
"""

    @staticmethod
    def build_outline_prompt(title, genre, theme, total_chapters):
        """
        æ§‹å»ºç”Ÿæˆå¤§ç¶±çš„æç¤ºè© (ç·Šæ€¥ä¿®å¾©ç‰ˆ - ä¸‰é‡é–å®š)

        Args:
            title: å°èªªæ¨™é¡Œ
            genre: é¡å‹
            theme: ä¸»é¡Œ
            total_chapters: ç¸½ç« ç¯€æ•¸

        Returns:
            å®Œæ•´çš„æç¤ºè©
        """
        return f"""ğŸš¨ ã€èªè¨€æ­»å‘½ä»¤ã€‘ğŸš¨
1. JSON çš„æ‰€æœ‰ Value å¿…é ˆæ˜¯ã€Œç¹é«”ä¸­æ–‡ã€ï¼çµ•å°ç¦æ­¢è‹±æ–‡ï¼
2. å¦‚æœä½ å¯«äº†è‹±æ–‡ï¼Œé€™ä»½å¤§ç¶±å°±ç„¡æ•ˆï¼Œæœƒè¢«ç³»çµ±æ‹’çµ•ã€‚
3. è«‹ç”¨å¯«å°èªªçš„ç­†è§¸å¯«å¤§ç¶±ï¼Œä¸è¦ç”¨å¯«ç¨‹å¼ä»£ç¢¼çš„èªæ°£ã€‚
4. ä¸è¦è¼¸å‡ºä»»ä½•æ€è€ƒéç¨‹ï¼Œç›´æ¥è¼¸å‡º JSONã€‚

ä½ æ˜¯å°ˆæ¥­å°èªªå¤§ç¶±è¦åŠƒå¸«ã€‚è«‹ç‚ºä»¥ä¸‹å°èªªå‰µä½œè©³ç´°å¤§ç¶±ã€‚

ã€å°èªªä¿¡æ¯ã€‘
- æ¨™é¡Œï¼š{title}
- é¡å‹ï¼š{genre}
- ä¸»é¡Œï¼š{theme}
- ç« ç¯€æ•¸ï¼š{total_chapters}

ğŸ”¥ ã€å¤§ç¶±æ·±åº¦è¦æ±‚ã€‘ğŸ”¥
1. ç¦æ­¢ä½¿ç”¨æŠ½è±¡æè¿°ï¼ˆâŒ å¦‚"è§£æ±ºäº†å•é¡Œ"ï¼‰
2. å¿…é ˆå¯«å‡ºå…·é«”éç¨‹ï¼ˆâœ… å¦‚"æ—æ™¨åœ¨å¯¦é©—å®¤ä¸­ç™¼ç¾äº†å¤ä»£å¯†ç¢¼ï¼Œç¶“éä¸‰å¤©è§£å¯†å¾Œå•Ÿå‹•äº†é˜²ç¦¦ç³»çµ±"ï¼‰
3. æ¯ç« å¤§ç¶±é•·åº¦è‡³å°‘ 150 å­—
4. å¿…é ˆåŒ…å«ï¼š
   - å…·é«”å ´æ™¯ï¼ˆåœ¨å“ªè£¡ç™¼ç”Ÿï¼‰
   - å…·é«”å‹•ä½œï¼ˆè§’è‰²åšäº†ä»€éº¼ï¼‰
   - é—œéµå°è©±æˆ–å¿ƒç†æ´»å‹•
   - æƒ…ç·’æ°›åœæå¯«

âš ï¸ ã€èªè¨€åš´æ ¼é™åˆ¶ã€‘
1. å…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡
2. JSON éµåç”¨è‹±æ–‡ï¼ˆtitle, summary, chaptersï¼‰
3. JSON å€¼å…¨éƒ¨ç¹é«”ä¸­æ–‡
4. çµ•å°ç¦æ­¢ä¸­è‹±æ··é›œï¼š
   - âŒ "discovery mysterious equipment"
   - âœ… "ç™¼ç¾ç¥ç§˜è¨­å‚™"
5. å°ˆæœ‰åè©æ‹¬è™Ÿæ¨™è¨»ï¼š
   - âœ… "äººå·¥æ™ºæ…§ (AI)"

ã€å¤§ç¶±ç¯„ä¾‹å°æ¯”ã€‘

âŒ éŒ¯èª¤ç¯„ä¾‹ï¼ˆå¤ªæŠ½è±¡ + è‹±æ–‡æ··é›œï¼‰ï¼š
"ç¬¬2ç« ï¼šface first wave of enemy AI forces"

âœ… æ­£ç¢ºç¯„ä¾‹ï¼ˆå…·é«”ç´°ç¯€ + å…¨ä¸­æ–‡ï¼‰ï¼š
"ç¬¬2ç« ï¼šå‡Œæ™¨ä¸‰é»çš„çªè¥²

å»¢å¢ŸåŸºåœ°çš„è­¦å ±é©Ÿç„¶éŸ¿èµ·ï¼Œæ—æ™¨å¾ç¡å¤¢ä¸­é©šé†’ã€‚ç›£æ§é¡¯ç¤ºä¸‰æ¶ä¸æ˜é£›è¡Œå™¨æ­£ä»¥æ¥µé€Ÿæ¥è¿‘ã€‚è‰¾å…‹æ–¯ç«‹å³å•Ÿå‹•é˜²ç¦¦ç³»çµ±ï¼Œä½†å¤è€çš„è¨­å‚™åæ‡‰é²ç·©ã€‚

ã€Œå¿«ï¼æ‰‹å‹•å•Ÿå‹•èƒ½é‡è­·ç›¾ï¼ã€æ—æ™¨è¡å‘æ§åˆ¶å°ã€‚

ç¬¬ä¸€æ³¢æ”»æ“Šä¾†å¾—çŒä¸åŠé˜²ï¼Œè­·ç›¾åƒ…æ“‹ä½äº†ä¸€åŠçš„è¡æ“Šã€‚çˆ†ç‚¸çš„ç«å…‰ç…§äº®äº†å¤œç©ºï¼ŒåŸºåœ°å¤–åœçš„ä¸‰è™Ÿå€‰åº«ç¬é–“åŒ–ç‚ºå»¢å¢Ÿã€‚åœ˜éšŠåœ¨æ··äº‚ä¸­ç™¼ç¾ï¼Œæ•µäººçš„ç›®æ¨™ä¸¦éæ‘§æ¯€åŸºåœ°ï¼Œè€Œæ˜¯ç«Šå–ä»–å€‘å‰æ—¥ç™¼ç¾çš„å¤ä»£æ ¸å¿ƒã€‚

ä¸€å ´çˆ­å¥ªæˆ°åœ¨å»¢å¢Ÿä¸­å±•é–‹ï¼Œå‹è² æœªçŸ¥ã€‚"

ã€è¼¸å‡ºæ ¼å¼ã€‘
åªè¼¸å‡ºä»¥ä¸‹ JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å…§å®¹ï¼š

{{
    "title": "å°èªªæ¨™é¡Œï¼ˆç¹é«”ä¸­æ–‡ï¼‰",
    "summary": "æ•´é«”æ•…äº‹æ¢—æ¦‚ï¼ˆç¹é«”ä¸­æ–‡ï¼Œ200-300å­—ï¼ŒåŒ…å«èµ·æ‰¿è½‰åˆï¼‰",
    "characters": [
        {{
            "name": "è§’è‰²åï¼ˆç¹é«”ä¸­æ–‡ï¼‰",
            "desc": "è§’è‰²èƒŒæ™¯ã€æ€§æ ¼ã€å‹•æ©Ÿï¼ˆç¹é«”ä¸­æ–‡ï¼Œ50-100å­—ï¼‰"
        }}
    ],
    "chapters": [
        {{
            "chapter_id": 1,
            "title": "ç¬¬ä¸€ç« æ¨™é¡Œï¼ˆç¹é«”ä¸­æ–‡ï¼Œå…·é«”äº‹ä»¶ï¼‰",
            "outline": "è©³ç´°åŠ‡æƒ…å¤§ç¶±ï¼ˆç¹é«”ä¸­æ–‡ï¼Œ150-200å­—ï¼‰ã€‚å¿…é ˆåŒ…å«ï¼šå…·é«”å ´æ™¯ã€è§’è‰²å‹•ä½œã€é—œéµå°è©±æˆ–å¿ƒç†ã€æƒ…ç·’æ°›åœã€‚ç¦æ­¢æŠ½è±¡æè¿°ã€‚"
        }}
    ]
}}

ğŸš¨ æœ€å¾Œæé†’ï¼š
- ä¸è¦è¼¸å‡ºæ€è€ƒéç¨‹
- ä¸è¦è¼¸å‡ºè‹±æ–‡
- ä¸è¦ä½¿ç”¨æŠ½è±¡æè¿°
- ç›´æ¥è¼¸å‡ºå®Œæ•´ JSON

ç¾åœ¨é–‹å§‹å‰µä½œå§ï¼"""

    @staticmethod
    def build_chapter_prompt(chapter_num, total_chapters, outline, previous_chapter=""):
        """
        æ§‹å»ºç”Ÿæˆç« ç¯€çš„æç¤ºè©

        Args:
            chapter_num: ç•¶å‰ç« ç¯€è™Ÿ
            total_chapters: ç¸½ç« ç¯€æ•¸
            outline: æ•…äº‹å¤§ç¶±
            previous_chapter: ä¸Šä¸€ç« å…§å®¹ï¼ˆå¯é¸ï¼‰

        Returns:
            å®Œæ•´çš„æç¤ºè©
        """
        parts = []

        # 1. ç³»çµ±è¦å‰‡
        parts.append(PromptTemplates.SYSTEM_CORE)
        parts.append(PromptTemplates.FORMAT_RULES)
        parts.append(PromptTemplates.CONSISTENCY_RULES)

        # 1.5 èªè¨€ä¿®æ­£æŒ‡ä»¤ï¼ˆGLM-4 çš„ä¸­æ–‡ä¿®å¾©ï¼‰
        parts.append("""
ã€èªè¨€å“è³ªè¦æ±‚ã€‘
âš ï¸ é‡è¦ï¼šå¦‚æœå¤§ç¶±ä¸­åŒ…å«è‹±æ–‡æè¿°æˆ–ä¸­è‹±æ··é›œï¼Œè«‹åœ¨æ’°å¯«æ­£æ–‡æ™‚è‡ªå‹•å°‡å…¶è½‰åŒ–ç‚ºé€šé †çš„ç¹é«”ä¸­æ–‡ã€‚

ç¯„ä¾‹è½‰æ›ï¼š
âŒ ã€ŒAI Agentã€ â†’ âœ… ã€Œäººå·¥æ™ºæ…§ä»£ç†ã€
âŒ ã€Œteam discoveryã€ â†’ âœ… ã€Œåœ˜éšŠç™¼ç¾ã€
âŒ ã€Œbattleã€ â†’ âœ… ã€Œæˆ°é¬¥ã€
âŒ ã€Œå¤ä»£ deviceã€ â†’ âœ… ã€Œå¤ä»£è£ç½®ã€

è¦æ±‚ï¼š
1. æ­£æ–‡å¿…é ˆå…¨æ˜¯ç¹é«”ä¸­æ–‡ï¼Œä¸å¾—æœ‰ä»»ä½•è‹±æ–‡å–®è©
2. å°ˆæœ‰åè©å¯ç”¨æ‹¬è™Ÿæ¨™è¨»ï¼šã€Œè³½åšé¾å…‹ (Cyberpunk)ã€
3. ä¿æŒæµæš¢è‡ªç„¶ï¼Œä¸è¦ç”Ÿç¡¬ç¿»è­¯
""")

        # 2. ç•¶å‰ä»»å‹™
        parts.append(f"""
ç•¶å‰ä»»å‹™:
- å‰µä½œç¬¬ {chapter_num} ç« ï¼ˆå…± {total_chapters} ç« ï¼‰
- å­—æ•¸è¦æ±‚ï¼š2500-3500 å­—
""")

        # 3. æ•…äº‹å¤§ç¶±
        parts.append(f"ã€æ•…äº‹å¤§ç¶±ã€‘\n{outline}\n")

        # 4. ä¸Šä¸€ç« å…§å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
        if previous_chapter and chapter_num > 1:
            # åªä¿ç•™ä¸Šä¸€ç« çš„æœ€å¾Œ 1000 å­—ä½œç‚ºä¸Šä¸‹æ–‡
            preview_length = min(1000, len(previous_chapter))
            preview = previous_chapter[-preview_length:]
            parts.append(f"ã€ä¸Šä¸€ç« çµå°¾ã€‘\n...{preview}\n")

        # 5. æœ¬ç« è¦æ±‚
        if chapter_num == 1:
            parts.append(f"""
æœ¬ç« è¦æ±‚ï¼ˆç¬¬ 1 ç« ï¼‰:
- å¼•å…¥ä¸»è§’å’ŒèƒŒæ™¯è¨­å®š
- å»ºç«‹æ•…äº‹çš„åŸºæœ¬ä¸–ç•Œè§€
- è¨­ç½®åˆå§‹è¡çªæˆ–æ‡¸å¿µ
- å¸å¼•è®€è€…ç¹¼çºŒé–±è®€

ç¾åœ¨å‰µä½œç¬¬ {chapter_num} ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼š
""")
        elif chapter_num == total_chapters:
            parts.append(f"""
æœ¬ç« è¦æ±‚ï¼ˆæœ€çµ‚ç« ï¼‰:
- è§£æ±ºä¸»è¦è¡çª
- ç‚ºè§’è‰²æä¾›çµå±€
- æ”¶å°¾æ‰€æœ‰é‡è¦ä¼ç­†
- çµ¦è®€è€…æ»¿æ„çš„çµæŸ

ç¾åœ¨å‰µä½œç¬¬ {chapter_num} ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼š
""")
        else:
            parts.append(f"""
æœ¬ç« è¦æ±‚ï¼ˆç¬¬ {chapter_num} ç« ï¼‰:
- æ‰¿æ¥ä¸Šä¸€ç« åŠ‡æƒ…
- æ¨é€²æ•…äº‹ç™¼å±•
- ä¿æŒç¯€å¥å’Œå¼µåŠ›
- ç‚ºä¸‹ä¸€ç« åŸ‹ä¸‹ä¼ç­†

ç¾åœ¨å‰µä½œç¬¬ {chapter_num} ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼š
""")

        return "\n".join(parts)

    @staticmethod
    def build_test_prompt():
        """æ§‹å»º API æ¸¬è©¦æç¤ºè©"""
        return "è«‹ç”¨ä¸€å¥è©±ä»‹ç´¹ä½ è‡ªå·±ã€‚"

    # ===== Phase 2: é€²éšæç¤ºè© =====

    @staticmethod
    def build_volume_plan_prompt(title: str, genre: str, theme: str, total_chapters: int) -> str:
        """
        æ§‹å»ºåˆ†å·è¦åŠƒæç¤ºè©

        Args:
            title: å°èªªæ¨™é¡Œ
            genre: é¡å‹
            theme: ä¸»é¡Œ
            total_chapters: ç¸½ç« ç¯€æ•¸

        Returns:
            åˆ†å·è¦åŠƒæç¤ºè©
        """
        return f"""è«‹ç‚ºä»¥ä¸‹é•·ç¯‡å°èªªè¦åŠƒåˆ†å·çµæ§‹ï¼š

å°èªªè³‡è¨Š:
- æ¨™é¡Œï¼š{title}
- é¡å‹ï¼š{genre}
- ä¸»é¡Œï¼š{theme}
- ç¸½ç« ç¯€æ•¸ï¼š{total_chapters}

è«‹æ ¹æ“šå°èªªé•·åº¦å’ŒåŠ‡æƒ…ç™¼å±•ï¼Œè¦åŠƒåˆç†çš„åˆ†å·æ–¹æ¡ˆã€‚

è¦åŠƒè¦æ±‚:
1. æ¯å·æ‡‰æœ‰æ˜ç¢ºçš„ä¸»é¡Œå’Œç›®æ¨™
2. å·èˆ‡å·ä¹‹é–“æœ‰æ¸…æ™°çš„éšæ®µéæ¸¡
3. å»ºè­°æ¯å· 15-30 ç« 
4. ç‚ºæ¯å·å‘½åä¸¦èªªæ˜æ ¸å¿ƒå…§å®¹

è«‹ä»¥ JSON æ ¼å¼è¼¸å‡ºåˆ†å·æ–¹æ¡ˆï¼ŒåŒ…å«ï¼š
- total_volumes: ç¸½å·æ•¸
- volumes: å·åˆ—è¡¨ï¼Œæ¯å·åŒ…å« volume_num, title, theme, chapter_count

è«‹é–‹å§‹è¦åŠƒï¼š"""

    @staticmethod
    def build_volume_outline_prompt(
        title: str,
        genre: str,
        theme: str,
        volume_num: int,
        volume_title: str,
        volume_theme: str,
        start_chapter: int,
        end_chapter: int,
        total_volumes: int,
        previous_volume_summary: str = ""
    ) -> str:
        """
        æ§‹å»ºå·å¤§ç¶±æç¤ºè©

        Args:
            title: å°èªªæ¨™é¡Œ
            genre: é¡å‹
            theme: ç¸½ä¸»é¡Œ
            volume_num: å·è™Ÿ
            volume_title: å·æ¨™é¡Œ
            volume_theme: å·ä¸»é¡Œ
            start_chapter: èµ·å§‹ç« ç¯€
            end_chapter: çµæŸç« ç¯€
            total_volumes: ç¸½å·æ•¸
            previous_volume_summary: ä¸Šä¸€å·æ‘˜è¦ï¼ˆå¯é¸ï¼‰

        Returns:
            å·å¤§ç¶±æç¤ºè©
        """
        previous_context = ""
        if previous_volume_summary:
            previous_context = f"""
ã€ä¸Šä¸€å·å›é¡§ã€‘
{previous_volume_summary}
"""

        return f"""è«‹ç‚ºä»¥ä¸‹å°èªªçš„ç¬¬ {volume_num} å·å‰µä½œè©³ç´°å¤§ç¶±ï¼š

å°èªªè³‡è¨Š:
- æ¨™é¡Œï¼š{title}
- é¡å‹ï¼š{genre}
- ç¸½ä¸»é¡Œï¼š{theme}

æœ¬å·è³‡è¨Š:
- å·è™Ÿï¼šç¬¬ {volume_num} å·ï¼ˆå…± {total_volumes} å·ï¼‰
- å·æ¨™é¡Œï¼š{volume_title}
- å·ä¸»é¡Œï¼š{volume_theme}
- ç« ç¯€ç¯„åœï¼šç¬¬ {start_chapter}-{end_chapter} ç« 
{previous_context}
è«‹ç”ŸæˆåŒ…å«ä»¥ä¸‹å…§å®¹çš„å·å¤§ç¶±ï¼š

1. ã€å·æ¦‚è¦ã€‘ï¼ˆ300-400å­—ï¼‰
   - æœ¬å·çš„æ ¸å¿ƒåŠ‡æƒ…ç·š
   - ä¸»è¦è¡çªå’ŒæŒ‘æˆ°
   - è§’è‰²æˆé•·è»Œè·¡
   - èˆ‡ç¸½ä¸»é¡Œçš„å‘¼æ‡‰

2. ã€é—œéµè½‰æŠ˜é»ã€‘
   - åˆ—å‡ºæœ¬å·çš„ 3-5 å€‹é—œéµäº‹ä»¶
   - æ¯å€‹äº‹ä»¶èªªæ˜ç™¼ç”Ÿçš„å¤§è‡´ç« ç¯€å’Œå½±éŸ¿

3. ã€è§’è‰²ç™¼å±•ã€‘
   - ä¸»è¦è§’è‰²åœ¨æœ¬å·çš„è®ŠåŒ–
   - æ–°è§’è‰²çš„å¼•å…¥ï¼ˆå¦‚æœæœ‰ï¼‰

4. ã€ç‚ºä¸‹ä¸€å·é‹ªå¢Šã€‘
   - åŸ‹ä¸‹çš„ä¼ç­†
   - æœªè§£æ±ºçš„æ‡¸å¿µ

è«‹é–‹å§‹å‰µä½œå¤§ç¶±ï¼š"""

    @staticmethod
    def build_chapter_outline_prompt_phase2(
        title: str,
        genre: str,
        volume_num: int,
        volume_outline: str,
        chapter_num: int,
        total_chapters: int,
        chapter_type: str,
        conflict_level: float,
        plot_guidance: dict,
        previous_outline: str = "",
        previous_outlines: list = None
    ) -> str:
        """
        æ§‹å»ºç« ç¯€å¤§ç¶±æç¤ºè©ï¼ˆPhase 2 ç‰ˆæœ¬ï¼Œæ•´åˆåŠ‡æƒ…æ§åˆ¶ï¼‰

        Args:
            title: å°èªªæ¨™é¡Œ
            genre: é¡å‹
            volume_num: å·è™Ÿ
            volume_outline: å·å¤§ç¶±
            chapter_num: ç« ç¯€è™Ÿ
            total_chapters: ç¸½ç« ç¯€æ•¸
            chapter_type: ç« ç¯€é¡å‹ï¼ˆopening/setup/development/escalation/climax/resolutionï¼‰
            conflict_level: è¡çªå¼·åº¦ï¼ˆ0-1ï¼‰
            plot_guidance: åŠ‡æƒ…æŒ‡å¼•å­—å…¸
            previous_outline: ä¸Šä¸€ç« å¤§ç¶±ï¼ˆå¯é¸ï¼‰
            previous_outlines: å‰å¹¾ç« å¤§ç¶±åˆ—è¡¨ï¼ˆç”¨æ–¼åæ¨¡å¼æª¢æ¸¬ï¼Œå¯é¸ï¼‰

        Returns:
            ç« ç¯€å¤§ç¶±æç¤ºè©
        """
        previous_context = ""
        if previous_outline:
            preview_length = min(200, len(previous_outline))
            previous_context = f"""
ã€ä¸Šä¸€ç« å¤§ç¶±ã€‘
{previous_outline[:preview_length]}...
"""

        # æ§‹å»ºåæ¨¡å¼è­¦å‘Šï¼ˆåŸºæ–¼å‰ 3 ç« ï¼‰
        anti_pattern_warning = ""
        if previous_outlines and len(previous_outlines) > 0:
            # å–æœ€è¿‘çš„ 3 ç« ï¼ˆæˆ–æ›´å°‘ï¼‰
            recent_outlines = previous_outlines[-3:] if len(previous_outlines) >= 3 else previous_outlines

            # æå–é—œéµæƒ…ç¯€é»
            pattern_lines = []
            for i, outline in enumerate(recent_outlines):
                chapter_index = chapter_num - len(recent_outlines) + i
                # æå–å‰ 150 å­—ä½œç‚ºé—œéµæƒ…ç¯€
                key_plot = outline[:150] if len(outline) > 150 else outline
                pattern_lines.append(f"  ç¬¬{chapter_index}ç« : {key_plot}...")

            patterns_text = "\n".join(pattern_lines)

            # è­˜åˆ¥å¸¸è¦‹æ¨¡å¼ï¼ˆç°¡åŒ–ç‰ˆï¼šæå–é«˜é »é—œéµè©ï¼‰
            common_keywords = []
            all_text = " ".join(recent_outlines)
            for keyword in ["å°è©±", "æˆ°é¬¥", "ç™¼ç¾", "é‡è¦‹", "æ±ºå®š", "å›æ†¶", "è¨ˆåŠƒ", "çˆ­åŸ·"]:
                if all_text.count(keyword) >= 2:
                    common_keywords.append(keyword)

            most_common = common_keywords[0] if common_keywords else "é‡è¤‡çš„æƒ…ç¯€æ¨¡å¼"

            anti_pattern_warning = f"""
âš ï¸ ã€åæ¨¡å¼è­¦å‘Šã€‘å‰é¢ç« ç¯€å·²ä½¿ç”¨çš„æƒ…ç¯€æ¨¡å¼ï¼š

{patterns_text}

ğŸš¨ æœ¬ç« å¿…é ˆå·®ç•°åŒ–ï¼š
- ä½¿ç”¨ä¸åŒçš„å ´æ™¯é¡å‹ï¼ˆé¿å…é‡è¤‡ç›¸åŒå ´æ™¯ï¼‰
- å¼•å…¥æ–°çš„è¡çªå°è±¡æˆ–çŸ›ç›¾é»
- æ¡ç”¨ä¸åŒçš„æ•˜äº‹ç¯€å¥ï¼ˆå¿«/æ…¢/å¼µå¼›æœ‰åº¦ï¼‰
- é¿å…é‡è¤‡ã€Œ{most_common}ã€çš„æ¨¡å¼
- å¾ä¸åŒè§’è‰²è¦–è§’æˆ–æƒ…æ„Ÿå±¤é¢å±•é–‹

ğŸ’¡ å·®ç•°åŒ–æ–¹å‘å»ºè­°ï¼š
  â€¢ å¦‚æœå‰ç« æ˜¯å°è©±ç‚ºä¸» â†’ æœ¬ç« å´é‡å‹•ä½œæˆ–ç’°å¢ƒæå¯«
  â€¢ å¦‚æœå‰ç« æ˜¯å¤–éƒ¨è¡çª â†’ æœ¬ç« å¯æ¢ç´¢å…§å¿ƒæ™æ‰
  â€¢ å¦‚æœå‰ç« æ˜¯ç·Šå¼µæ¿€çƒˆ â†’ æœ¬ç« å¯å¼µå¼›æœ‰åº¦æˆ–é‹ªå¢Šä¼ç­†
"""

        # æ ¼å¼åŒ–åŠ‡æƒ…æŒ‡å¼•
        pacing_hints = "\n".join(f"  - {s}" for s in plot_guidance.get('pacing_suggestions', []))
        content_focus = ", ".join(plot_guidance.get('content_focus', []))
        tone = plot_guidance.get('tone', '')

        return f"""è«‹ç‚ºä»¥ä¸‹å°èªªçš„ç¬¬ {chapter_num} ç« å‰µä½œè©³ç´°å¤§ç¶±ï¼š

å°èªªè³‡è¨Š:
- æ¨™é¡Œï¼š{title}
- é¡å‹ï¼š{genre}
- é€²åº¦ï¼šç¬¬ {chapter_num} ç«  / å…± {total_chapters} ç« 

æœ¬å·è³‡è¨Š:
- ç¬¬ {volume_num} å·

ã€å·å¤§ç¶±ã€‘
{volume_outline}
{previous_context}
{anti_pattern_warning}
åŠ‡æƒ…æ§åˆ¶æŒ‡å¼•:
- ç« ç¯€é¡å‹ï¼š{chapter_type}
- è¡çªå¼·åº¦ï¼š{conflict_level:.2f}ï¼ˆ0-1 ç¯„åœï¼Œè¶Šé«˜è¶Šæ¿€çƒˆï¼‰
- åŸºèª¿ï¼š{tone}
- å…§å®¹é‡é»ï¼š{content_focus}

ç¯€å¥å»ºè­°:
{pacing_hints}

è«‹ç”ŸæˆåŒ…å«ä»¥ä¸‹å…§å®¹çš„ç« ç¯€å¤§ç¶±ï¼ˆ250-350å­—ï¼‰ï¼š

1. ã€æ ¸å¿ƒäº‹ä»¶ã€‘
   - æœ¬ç« çš„ä¸»è¦æƒ…ç¯€ç™¼å±•
   - ç¬¦åˆç•¶å‰è¡çªå¼·åº¦è¦æ±‚

2. ã€è§’è‰²å‹•ä½œã€‘
   - ä¸»è¦è§’è‰²çš„è¡Œç‚ºå’Œæ±ºç­–
   - è§’è‰²é–“çš„äº’å‹•å’Œé—œä¿‚è®ŠåŒ–

3. ã€æƒ…ç·’ç¯€å¥ã€‘
   - ç« ç¯€æƒ…ç·’æ›²ç·šï¼ˆèµ·ä¼è®ŠåŒ–ï¼‰
   - ç¬¦åˆæŒ‡å®šåŸºèª¿

4. ã€ä¼ç­†é‹ªè¨­ã€‘
   - ç‚ºå¾ŒçºŒç« ç¯€åŸ‹ä¸‹ç·šç´¢
   - é¿å…èˆ‡ä¹‹å‰ç« ç¯€é‡è¤‡

æ³¨æ„äº‹é …:
- åš´æ ¼éµå®ˆå·å¤§ç¶±çš„ç¸½é«”æ–¹å‘
- ç¢ºä¿è¡çªå¼·åº¦ç¬¦åˆè¦æ±‚ï¼ˆç•¶å‰ {conflict_level:.2f}ï¼‰
- âš ï¸ ã€é‡è¦ã€‘æœ¬ç« å¤§ç¶±å¿…é ˆèˆ‡å‰å¹¾ç« æœ‰æ˜é¡¯å·®ç•°ï¼Œç¦æ­¢é‡è¤‡ç›¸ä¼¼çš„æƒ…ç¯€æ¨¡å¼
- åƒè€ƒä¸Šæ–¹ã€åæ¨¡å¼è­¦å‘Šã€‘ï¼Œä¸»å‹•é¿é–‹å·²ä½¿ç”¨çš„æ•˜äº‹æ‰‹æ³•
- ä¿æŒæ•…äº‹é€£è²«æ€§çš„åŒæ™‚ï¼Œè¿½æ±‚æƒ…ç¯€å‰µæ–°å’Œå¤šæ¨£æ€§

è«‹é–‹å§‹å‰µä½œå¤§ç¶±ï¼š"""

    @staticmethod
    def build_chapter_prompt_phase2(
        chapter_num: int,
        total_chapters: int,
        volume_num: int,
        volume_outline: str,
        chapter_outline: str,
        plot_guidance: dict,
        previous_chapter: str = "",
        character_states: dict = None,
        event_context: str = ""
    ) -> str:
        """
        æ§‹å»ºç« ç¯€å…§å®¹ç”Ÿæˆæç¤ºè©ï¼ˆPhase 2 ç‰ˆæœ¬ï¼‰

        Args:
            chapter_num: ç« ç¯€è™Ÿ
            total_chapters: ç¸½ç« ç¯€æ•¸
            volume_num: å·è™Ÿ
            volume_outline: å·å¤§ç¶±
            chapter_outline: æœ¬ç« å¤§ç¶±
            plot_guidance: åŠ‡æƒ…æŒ‡å¼•
            previous_chapter: ä¸Šä¸€ç« å…§å®¹ï¼ˆå¯é¸ï¼‰
            character_states: è§’è‰²ç‹€æ…‹å­—å…¸ï¼ˆå¯é¸ï¼‰
            event_context: äº‹ä»¶ä¸Šä¸‹æ–‡ï¼ˆå¯é¸ï¼‰

        Returns:
            ç« ç¯€ç”Ÿæˆæç¤ºè©
        """
        parts = []

        # 1. ç³»çµ±è¦å‰‡
        parts.append(PromptTemplates.SYSTEM_CORE)
        parts.append(PromptTemplates.FORMAT_RULES)
        parts.append(PromptTemplates.CONSISTENCY_RULES)

        # 2. ç•¶å‰ä»»å‹™
        parts.append(f"""
ç•¶å‰ä»»å‹™:
- å‰µä½œç¬¬ {chapter_num} ç« ï¼ˆç¬¬ {volume_num} å·ï¼Œå…± {total_chapters} ç« ï¼‰
- å­—æ•¸è¦æ±‚ï¼š2500-3500 å­—
- ç« ç¯€é¡å‹ï¼š{plot_guidance.get('chapter_type_name', 'ç™¼å±•ç« ç¯€')}
- è¡çªå¼·åº¦ï¼š{plot_guidance.get('conflict_level', 0.5):.2f}
""")

        # 3. å·å¤§ç¶±
        parts.append(f"ã€å·å¤§ç¶±ã€‘\n{volume_outline}\n")

        # 4. æœ¬ç« å¤§ç¶±
        parts.append(f"ã€æœ¬ç« å¤§ç¶±ã€‘\n{chapter_outline}\n")

        # 5. ä¸Šä¸€ç« å…§å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
        if previous_chapter and chapter_num > 1:
            preview_length = min(1000, len(previous_chapter))
            preview = previous_chapter[-preview_length:]
            parts.append(f"ã€ä¸Šä¸€ç« çµå°¾ã€‘\n...{preview}\n")

        # 6. è§’è‰²ç‹€æ…‹ï¼ˆå¦‚æœæœ‰ï¼‰
        if character_states:
            char_info = []
            for char, state in character_states.items():
                char_info.append(f"  - {char}: {state}")
            parts.append(f"ã€è§’è‰²ç‹€æ…‹ã€‘\n" + "\n".join(char_info) + "\n")

        # 7. äº‹ä»¶ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰
        if event_context:
            parts.append(f"ã€äº‹ä»¶èƒŒæ™¯ã€‘\n{event_context}\n")

        # 8. åŠ‡æƒ…æ§åˆ¶è¦æ±‚
        pacing_hints = "\n".join(f"  - {s}" for s in plot_guidance.get('pacing_suggestions', []))
        content_focus = "\n".join(f"  - {f}" for f in plot_guidance.get('content_focus', []))

        parts.append(f"""
åŠ‡æƒ…æ§åˆ¶è¦æ±‚:
- åŸºèª¿ï¼š{plot_guidance.get('tone', 'ç©©æ­¥æ¨é€²')}
- è¡çªå¼·åº¦ï¼š{plot_guidance.get('conflict_level', 0.5):.2f}ï¼ˆè«‹åœ¨æƒ…ç¯€è¨­è¨ˆä¸­é«”ç¾ï¼‰

ç¯€å¥å»ºè­°:
{pacing_hints}

å…§å®¹é‡é»:
{content_focus}
""")

        # 9. å‰µä½œæŒ‡ä»¤
        if chapter_num == 1:
            parts.append("""
æœ¬ç« è¦æ±‚ï¼ˆç¬¬ 1 ç« ï¼‰:
- å¼•å…¥ä¸»è§’å’Œæ ¸å¿ƒè¨­å®š
- å»ºç«‹æ•…äº‹åŸºèª¿å’Œä¸–ç•Œè§€
- è¨­ç½®åˆå§‹æ‡¸å¿µ
- å¸å¼•è®€è€…ç¹¼çºŒé–±è®€
- ç¬¦åˆé–‹å±€ç« ç¯€çš„ç¯€å¥

ç¾åœ¨å‰µä½œç¬¬ 1 ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼Œç›´æ¥é–‹å§‹æ­£æ–‡ï¼š
""")
        elif chapter_num == total_chapters:
            parts.append("""
æœ¬ç« è¦æ±‚ï¼ˆæœ€çµ‚ç« ï¼‰:
- è§£æ±ºä¸»è¦è¡çª
- ç‚ºè§’è‰²æä¾›çµå±€
- æ”¶å°¾æ‰€æœ‰é‡è¦ä¼ç­†
- çµ¦è®€è€…æ»¿æ„çš„çµæŸ
- ç¬¦åˆæ”¶å°¾ç« ç¯€çš„ç¯€å¥

ç¾åœ¨å‰µä½œæœ€çµ‚ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼Œç›´æ¥é–‹å§‹æ­£æ–‡ï¼š
""")
        else:
            parts.append(f"""
æœ¬ç« è¦æ±‚:
- åš´æ ¼æŒ‰ç…§ã€æœ¬ç« å¤§ç¶±ã€‘å±•é–‹æƒ…ç¯€
- æ‰¿æ¥ä¸Šä¸€ç« åŠ‡æƒ…ï¼Œç¢ºä¿é€£è²«æ€§
- é«”ç¾ {plot_guidance.get('conflict_level', 0.5):.2f} çš„è¡çªå¼·åº¦
- ä¿æŒ {plot_guidance.get('tone', 'ç©©æ­¥æ¨é€²')} çš„åŸºèª¿
- ç‚ºä¸‹ä¸€ç« åŸ‹ä¸‹ä¼ç­†

ç¾åœ¨å‰µä½œç¬¬ {chapter_num} ç« ï¼Œå­—æ•¸ 2500-3500 å­—ï¼Œç›´æ¥é–‹å§‹æ­£æ–‡ï¼š
""")

        return "\n".join(parts)


if __name__ == '__main__':
    # æ¸¬è©¦æç¤ºè©ç”Ÿæˆ
    templates = PromptTemplates()

    print("=== å¤§ç¶±ç”Ÿæˆæç¤ºè© ===")
    outline_prompt = templates.build_outline_prompt(
        title="æ˜Ÿéš›é‚Šç·£",
        genre="ç§‘å¹»",
        theme="äººé¡æ–‡æ˜çš„å­˜çºŒèˆ‡è›»è®Š",
        total_chapters=30
    )
    print(outline_prompt[:500], "...\n")

    print("=== ç« ç¯€ç”Ÿæˆæç¤ºè© ===")
    chapter_prompt = templates.build_chapter_prompt(
        chapter_num=1,
        total_chapters=30,
        outline="é€™æ˜¯ä¸€å€‹é—œæ–¼æ˜Ÿéš›æ¢ç´¢çš„æ•…äº‹...",
        previous_chapter=""
    )
    print(chapter_prompt[:500], "...")
